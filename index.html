<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUILIS - Gerenciador HUOL v6.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .erro-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .msg-erro { color: #ef4444; font-size: 10px; display: none; position: absolute; bottom: -14px; left: 2px; }
        
        #modalEstoque { display: none; }
        
        /* Força o modal a ter altura fixa e a lista interna a rolar */
        .modal-container {
            max-height: 85vh; 
            display: flex;
            flex-direction: column;
        }

        .lista-scroll {
            overflow-y: scroll !important; /* Força a existência da área de scroll */
            max-height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            background: #ffffff;
        }

        /* Barra de rolagem visível e azul para não ter erro */
        .lista-scroll::-webkit-scrollbar { width: 10px; }
        .lista-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .lista-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <datalist id="lista-anticorpos-estoque"></datalist>

    <div class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded shadow-md border-t-4 border-blue-600">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-blue-800 italic uppercase">GUILIS</h2>
                    <p class="text-gray-500 text-sm font-medium">HUOL • NATAL/RN</p>
                </div>
                <button onclick="abrirModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold hover:bg-blue-700 shadow-md">
                    ⚙️ GERENCIAR ESTOQUE
                </button>
            </div>
            
            <div id="container-inputs" class="space-y-1"></div>
            
            <div class="mt-8 flex flex-col gap-3">
                <div class="flex gap-2">
                    <button onclick="adicionarLinha()" class="bg-gray-200 text-gray-700 py-2 px-4 rounded font-bold hover:bg-gray-300 transition-all flex-1 text-sm">+ LINHA</button>
                    <button onclick="limparTabela()" class="bg-red-50 text-red-600 py-2 px-4 rounded font-bold hover:bg-red-100 transition-all flex-1 text-sm border border-red-100">LIMPAR TELA</button>
                </div>
                <button onclick="copiarComoTabela()" class="bg-orange-600 text-white font-black py-5 rounded shadow-xl active:scale-95 transition-all text-xl uppercase">COPIAR PARA O WORD</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded shadow-md overflow-x-auto">
            <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2 text-center text-sm">PREVIEW DO LAUDO</h2>
            <div id="area-tabela" class="flex justify-center"></div>
        </div>
    </div>

    <div id="modalEstoque" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl modal-container">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">GERENCIAR ANTICORPOS</h3>
                <button onclick="fecharModal()" class="text-gray-400 hover:text-red-500 text-3xl">&times;</button>
            </div>
            
            <div class="p-6 overflow-hidden flex flex-col">
                <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-100">
                    <p class="font-bold text-[10px] mb-2 text-blue-700 uppercase">Novo Cadastro:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        <input type="text" id="novoAnt" placeholder="Anticorpo" class="border p-2 rounded text-sm">
                        <input type="text" id="novoClo" placeholder="Clones (separe por vírgula)" class="border p-2 rounded text-sm">
                    </div>
                    <button onclick="salvarNovoItem()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-xs">SALVAR NO ESTOQUE</button>
                </div>

                <div class="lista-scroll" id="listaEstoqueEditavel"></div>
            </div>
        </div>
    </div>

    <script>
    // LISTA RECUPERADA
    const estoquePadrao = {
        "AML (actina músculo liso)": ["1A4 - Agilent","1A4 - Cell Marque"],
        "Alfafetoproteína" :["Cell Marque"],
        "CAIX" :["EP161 - Cell Marque"],
        "ALK1": ["ALK1 – Agilent", "ALK01 - Ventana"], // Agora com as duas opções
        "BCOR": ["C-10 - Zeta"],
        "BCL-2" : ["124 – Agilent","124 - Ventana" ],
        "BCL-6" : ["PG-B6p – Agilent","GL191E/A8 - Cell Marque"],
        "BER-EP4" : ["Agilent", "Ber-EP4 - Cell Marque"],
        "Beta-Catenina" : ["β-Catenin-1 – Agilent","Policlonal - Cell Marque"],
        "Beta-HCG" : ["Policlonal - Cell Marque"],
        "c-KIT" : ["EP10 - Ventana"],
        "c-MYC" : ["Ventana"],
        "CA125" : ["Agilent", "OC125 - Cell Marque"],
        "CA19.9" : ["121SLE - Cell Marque"],
        "Calcitonina" : ["SP17 - Cell Marque"],
        "Caldesmon" : ["h-CD – Agilent","E89 - Cell Marque"],
        "Calponina" : ["EP798Y - Cell Marque"],
        "Calretinina" : ["DAK-Calret 1 – Agilent", "SP65 - Ventana"],
        "Carcinoembrionário" : ["II-7 – Agilent"],
        "CD1a" : ["010 – Agilent", "EP3622 - Cell Marque"],
        "CD2" : ["AB75 – Agilent","MRQ-11 - Cell Marque"],
        "CD3" : ["policlonal – Agilent","2GV6 - Ventana"],
        "CD4" : ["4B12 – Agilent","SP35 - Ventana"],
        "CD5" : ["4C7 – Agilent", "SP19 - Ventana"],
        "CD7" : ["CBC.37 – Agilent","SP94 - Ventana"],
        "CD8" : ["C8/144B – Agilent","SP57 - Ventana"],
        "CD10" : ["DAK-CD10 – Agilent","SP67 - Ventana"],
        "CD15" : ["Carb-3 – Agilent","MMA - Ventana"],
        "CD20" : ["L26 – Agilent","L26 - Ventana"],
        "CD21" : ["1F8 – Agilent"],
        "CD23" : ["DAK-CD23 – Agilent","CD23: SP23 - Ventana"],
        "CD30" : ["Ber-H2 – Agilent", "Ber-H2 - Ventana"],
        "CD31" : ["JC70A – Agilent","JC70 - Cell Marque"],
        "CD34" : ["QBEnd 10 – Agilent","QBEnd/10 - Ventana"],
        "CD43" : ["DF-T1 – Agilent", "L60 - Ventana"],
        "CD45" : ["2B11 + PD7/26 – Agilent","2B11 & PD7/26 - Cell Marque"],
        "CD56" : ["123C3 – Agilent","MRQ-42 - Cell Marque"],
        "CD57" : ["NK1 - Cell Marque"],
        "CD61" : ["2f2 - Cell Marque"],
        "CD68" : ["KP1 – Agilent","KP1 - Ventana"],
        "CD79a": ["JCB117 – Agilent","CD79a: SP18 - Ventana"],
        "CD99": ["12E7 - Agilent", "O13 - Ventana"],
        "TTF-1": ["8G7G3/1 - Agilent", "8G7G3/1 - Ventana"],
        "CD138": ["MI15 - Agilent", "B-A38 - Cell Marque"],
        "WT-1": ["6FH2 - Agilent", "6F-H2 - Cell Marque"],
        "CDX2": ["DAK-CDX2 - Agilent", "EPR2764Y - Cell Marque"],
        "Ciclina D1": ["EP12 - Agilent", "SP4-R - Ventana"],
        "Citoqueratina 5/6": ["D5/16 B4 - Agilent", "D5/16B4 - Ventana"],
        "Citoqueratina 7": ["OV-TL 12/30 - Agilent", "SP52 - Ventana"],
        "Citoqueratina 8/18": ["EP17/30 - Agilent", "B22.1 & B23.1 - Cell Marque"],
        "Citoqueratina 19": ["RCK108 - Agilent", "A53-B/A2.26 - Cell Marque"],
        "Citoqueratina 20": ["Ks20.8 - Agilent", "SP33 - Ventana"],
        "Citoqueratina 34βE12": ["34βE12 - Agilent", "34B12 - Ventana"],
        "Desmina": ["D33 - Agilent", "DE-R-11 - Ventana"],
        "E-Caderina": ["NCH-38 - Agilent", "36 - Ventana"],
        "EMA": ["E29 - Agilent", "E29 - Ventana"],
        "Fator von Willebrand": ["Policlonal - Agilent"],
        "Fator VIII": ["Policlonal - Cell Marque"],
        "Fator XIIIa": ["AC-1A1 - Cell Marque"],
        "GFAP": ["Policlonal - Agilent", "EP672Y - Cell Marque"],
        "Hepatocyte": ["OCH1E5 - Agilent", "OCH1E5 - Cell Marque"],
        "Inibina": ["R1 - Agilent"],
        "Inibina-α": ["R1 - Agilent"],
        "Kappa": ["Policlonal - Agilent", "Policlonal - Ventana"],
        "Lambda": ["Policlonal - Agilent", "Policlonal - Ventana"],
        "Ki-67": ["MIB1 - Agilent", "30-9 - Ventana"],
        "Melan-A": ["A103 - Agilent", "A103 - Ventana"],
        "Melanossomo": ["HMB45 - Agilent", "HMB45 - Ventana"],
        "MLH1": ["ES05 - Agilent", "M1 - Ventana"],
        "MSH2": ["FE11 - Agilent", "G219-1129 - Ventana"],
        "MSH6": ["EP49 - Agilent", "EP49 - Ventana"],
        "PMS2": ["EP51 - Agilent", "A16-4 - Ventana"],

        "MUM1": ["MUM1p - Agilent", "MRQ-43 - Cell Marque"],
        "Mieloperoxidase": ["Policlonal - Agilent", "Policlonal - Cell Marque"],
        "Miogenina": ["F5D - Agilent", "F5D - Cell Marque"],

        "OCT3/4": ["N1NK - Agilent", "MRQ-10 - Cell Marque"],
        "p40": ["DAK-p40 - Agilent", "BC28 - Ventana"],
        "p53": ["DO-7 - Agilent", "DO-7 - Cell Marque"],
        "p63": ["DAK-p63 - Agilent", "4A4 - Ventana"],

        "PAX-5": ["DAK-Pax5 - Agilent", "SP34 - Ventana"],
        "PLAP": ["8A9 - Agilent", "NB10 - Cell Marque"],
        "PSA": ["3E6 - Agilent", "Policlonal - Ventana"],
        "Racemase": ["13H4 - Agilent", "SP116 - Ventana"],

        "Receptor de Estrógeno": ["EP1 - Agilent", "SP1 - Ventana"],
        "Receptor de Progesterona": ["PgR 636 - Agilent", "1E2 - Ventana"],

        "S100": ["Policlonal - Agilent", "4C4.9 - Ventana"],
        "Sinaptofisina": ["DAK-SYNAP - Agilent", "MRQ-40 - Cell Marque"],
        "TDT": ["EP266 - Agilent", "Policlonal - Cell Marque"],
        "Tireoglobulina": ["Policlonal - Agilent", "2H11 + 6E1 - Cell Marque"]

    };

    let estoqueIHQ = JSON.parse(localStorage.getItem('guilis_estoque')) || estoquePadrao;

    function salvarEstoque() {
        localStorage.setItem('guilis_estoque', JSON.stringify(estoqueIHQ));
        popularDatalist(""); 
        atualizarListaEditavel();
    }

    function popularDatalist(termo) {
        const dl = document.getElementById('lista-anticorpos-estoque');
        dl.innerHTML = '';
        const chaves = Object.keys(estoqueIHQ).sort();
        
        // FILTRO PELA PRIMEIRA LETRA (startsWith)
        const filtradas = chaves.filter(k => k.toLowerCase().startsWith(termo.toLowerCase()));
        
        filtradas.forEach(ant => {
            const opt = document.createElement('option');
            opt.value = ant;
            dl.appendChild(opt);
        });
    }

    function salvarNovoItem() {
        const ant = document.getElementById('novoAnt').value.trim();
        const cloString = document.getElementById('novoClo').value.trim();
        if (!ant || !cloString) return alert("Preencha os campos!");
        estoqueIHQ[ant] = cloString.split(',').map(s => s.trim());
        document.getElementById('novoAnt').value = '';
        document.getElementById('novoClo').value = '';
        salvarEstoque();
    }

    function removerItem(chave) {
        if (confirm(`Excluir ${chave}?`)) {
            delete estoqueIHQ[chave];
            salvarEstoque();
        }
    }

    function atualizarListaEditavel() {
        const container = document.getElementById('listaEstoqueEditavel');
        container.innerHTML = '<p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Itens no Sistema:</p>';
        Object.keys(estoqueIHQ).sort().forEach(chave => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 mb-1 border-b text-sm bg-white';
            div.innerHTML = `
                <div><span class="font-bold text-blue-900">${chave}</span><p class="text-[9px] text-gray-400">${estoqueIHQ[chave].join(' | ')}</p></div>
                <button onclick="removerItem('${chave}')" class="text-red-300 hover:text-red-500 text-xl px-2">&times;</button>
            `;
            container.appendChild(div);
        });
    }

    function abrirModal() { document.getElementById('modalEstoque').style.display = 'flex'; atualizarListaEditavel(); }
    function fecharModal() { document.getElementById('modalEstoque').style.display = 'none'; }

    function criarLinhaUI(index) {
        const div = document.createElement('div');
        div.className = 'flex gap-1 items-start linha-input relative mb-1';
        div.id = `linha-${index}`;
        div.innerHTML = `
            <div class="flex flex-col w-[25%] relative">
                <input type="text" list="lista-anticorpos-estoque" placeholder="Ant..." 
                    oninput="processarInput(${index}, this)" class="ant border p-2 rounded w-full text-sm outline-none">
                <span class="msg-erro">Erro</span>
            </div>
            <select onchange="sincronizar()" class="clo border p-2 rounded w-[35%] text-sm outline-none bg-white" disabled><option value="">---</option></select>
            <input type="text" placeholder="Result" oninput="sincronizar()" class="res border p-2 rounded w-[40%] text-sm outline-none">
        `;
        return div;
    }

    function processarInput(index, elemento) {
        const valor = elemento.value;
        const linha = document.getElementById(`linha-${index}`);
        const selectClo = linha.querySelector('.clo');
        const spanErro = linha.querySelector('.msg-erro');
        
        popularDatalist(valor); // Filtra conforme digita

        if (valor === "") {
            elemento.classList.remove('erro-input');
            spanErro.style.display = 'none';
        } else if (estoqueIHQ[valor]) {
            elemento.classList.remove('erro-input');
            spanErro.style.display = 'none';
            const opcoes = estoqueIHQ[valor];
            selectClo.disabled = false;
            selectClo.innerHTML = '';
            if (opcoes.length === 1) {
                selectClo.innerHTML = `<option value="${opcoes[0]}" selected>${opcoes[0]}</option>`;
            } else {
                let h = '<option value=""> INSIRA O CLONE </option>';
                opcoes.forEach(o => h += `<option value="${o}">${o}</option>`);
                selectClo.innerHTML = h;
            }
        } else {
            elemento.classList.add('erro-input');
            spanErro.style.display = 'block';
            selectClo.disabled = true;
        }
        sincronizar();
    }

    function sincronizar() {
        const area = document.getElementById('area-tabela');
        const b = "1.8pt solid black";
        let h = `<table style="border-collapse:collapse; width:523pt; font-family:'Trade Gothic Next Rounded', Arial; border:${b}; table-layout:fixed;">`;
        h += `<tr style="background:#D9D9D9; font-weight:bold; height:21.5pt;">
                <th style="border:${b}; padding:0 8px; width:80pt; text-align:left; font-size:14px; vertical-align:middle;">ANTICORPO</th>
                <th style="border:${b}; padding:0 8px; width:129pt; text-align:left; font-size:14px; vertical-align:middle;">CLONE-FABRICANTE</th>
                <th style="border:${b}; padding:0 8px; width:314pt; text-align:left; font-size:14px; vertical-align:middle;">RESULTADO</th>
              </tr>`;
        document.querySelectorAll('.linha-input').forEach(div => {
            const a = div.querySelector('.ant').value; const c = div.querySelector('.clo').value; const r = div.querySelector('.res').value;
            if (estoqueIHQ[a]) {
                h += `<tr style="height:15pt;">
                        <td style="border:${b}; padding:0 8px; font-size:14px; vertical-align:middle;">${a}</td>
                        <td style="border:${b}; padding:0 8px; font-size:14px; vertical-align:middle;">${c}</td>
                        <td style="border:${b}; padding:0 8px; font-size:14px; vertical-align:middle;">${r}</td>
                      </tr>`;
            }
        });
        h += `</table>`; area.innerHTML = h;
    }

    function adicionarLinha() {
        const c = document.getElementById('container-inputs');
        c.appendChild(criarLinhaUI(c.children.length));
    }

    function limparTabela() {
        if (confirm("Limpar tela?")) {
            document.getElementById('container-inputs').innerHTML = '';
            for(let i=0; i<8; i++) adicionarLinha();
            sincronizar();
        }
    }

    function copiarComoTabela() {
        const a = document.getElementById('area-tabela');
        const b = new Blob([a.innerHTML], { type: "text/html" });
        navigator.clipboard.write([new ClipboardItem({ "text/html": b })]).then(() => alert("Copiado!"));
    }

    popularDatalist("");
    for(let i=0; i<8; i++) adicionarLinha();
    sincronizar();
    </script>
</body>
</html>
